FROM oven/bun:1-alpine

WORKDIR /workspace

# Copy root package.json and workspace configuration
COPY package.json bun.lock ./
COPY turbo.json ./
COPY tsconfig.json ./

# Copy shared package
COPY packages/shared ./packages/shared/

# Copy backend package.json
COPY apps/backend/package.json ./apps/backend/

# Copy prisma schema BEFORE bun install (needed for postinstall script)
COPY apps/backend/prisma ./apps/backend/prisma/

# Install all dependencies (including workspace packages)
# This will trigger postinstall script which runs prisma generate
RUN bun install

# Switch to backend directory
WORKDIR /workspace/apps/backend

# Copy backend source code
COPY apps/backend/src ./src/
COPY apps/backend/tsconfig.json ./

# Expose port
EXPOSE 3001

# Development command with hot reload
CMD ["bun", "--watch", "src/server.ts"]
